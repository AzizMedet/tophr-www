# Подключение к сокету
- **_Z.socketioConnect** - функция которая делает подключение веб сокета, она вызывается в теле функции **_Z.init4**(первый вход в систему) и **_Z.restartSession** (подключение через поп-ап после истечения срока сессии), реализована в файле **zcmk04.js**

# Базовые функции сокета
- _**io**_ - объект через который мы получаем доступ к веб сокету, этот объект доступен благодаря ` <script type="text/javascript" src="/socket.io/socket.io.js"></script>` в login.html. Если этот объект не доступен, зайти в систему не получится. Он может быть не доступен по следующим причинам:
    1. Не подгрузился ```html <script type="text/javascript" src="/socket.io/socket.io.js"></script>``` изза медленного интернета
    2. Node.js сервер остановлен (во фронте по ссылке **/socket.io/socket.io.js** физического файла нет, его кидает нам node.js сервер )


- _**io.connect**_ - функция подключения к сокету. пример `io.connect(socket_link,{path: '/socket.io', transports: ['websocket'], secure: true, reconnection: false});`
    - Параметры: 
      1. host и port сокета, тип стринг(например `'https://tophr.kz:443'`)
      2. дополнительные параметры подключении, тип JSON
          - path: путь на который будет подключаться сокет, тип стринг
          - transports: типы транспорта которые будет использовать сокет, типа массив
          - secure: будет ли использовать https, тип булеан
          - reconnection: будет ли автоматический пере подключаться, тип булеан
    - Возвращает: экземпляр сокета, записываем его в Zcommon.socket, и через него можем теперь создавать новые лиснеры, делать подключения к комнатам, отключать сокет, кидать сообщения на сервер 


- _**Zcommon.socket.on**_ - функция, создается новый лиснер для сокета.
    - Параметры: 
      1. Название события, тип стринг
      2. callback, функция, вызывается когда события сработало (то есть пришло сообщение с сервера), параметры могут быть любого количества любого типа, в зависимости как сервер node.js отправляет данные
    - Пример: `Zcommon.socket.on(channel, function(msg[,...] ) {})`


- _**Zcommon.socket.removeAllListeners**_ - функция, удаляет заданный лиснер
    - Параметр: 
      1. Название события, тип стринг
    - Пример: `Zcommon.socket.removeAllListeners(channel);`

- _**Zcommon.socket.emit**_ - функция, отправляет событие на сервер, если на сервере есть обработка этого события, то она выполнится, если обработка нет, но ничего не произойдет
    - Параметры: 
      1. Название события, тип стринг
      2. Параметр, любого типа (можно отправлять неограниченное количество параметров через запятую, в зависимости от лиснера события настроенного на сервере)
    - Пример: `Zcommon.socket.emit('leave room', roomname[,...] );`

# Список событий и их предназначение (так же смотрите серверную часть [здесь](https://gitlab.com/cloudmaker/tophr/tophr-www/-/wikis/NodeJS/02.-%D0%9B%D0%BE%D0%B3%D0%B8%D0%BA%D0%B0-%D0%B2-index.js/05.-%D0%92%D0%B5%D0%B1-%D1%81%D0%BE%D0%BA%D0%B5%D1%82%D1%8B-(%D0%A1%D0%B5%D1%80%D0%B2%D0%B5%D1%80)#%D0%BB%D0%B8%D1%81%D0%BD%D0%B5%D1%80%D1%8B-%D1%82%D0%B0%D0%BA-%D0%B6%D0%B5-%D1%81%D0%BC%D0%BE%D1%82%D1%80%D0%B8%D1%82%D0%B5-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D1%81%D0%BA%D1%83%D1%8E-%D1%87%D0%B0%D1%81%D1%82%D1%8C-%D0%B7%D0%B4%D0%B5%D1%81%D1%8C))

### События которые клиентский сокет отправляет на сервер (`Zcommon.socket.emit`)
1. **'join room'** - сокет вступает в комнату (подписка), которую задали в параметре, сервер имеет возможность отправить сообщение только в определенную комнату, тогда сообщение получат только те сокеты, которые состоят в той комнате (пример: `Zcommon.socket.emit('join room', roomname)`)
2. **'leave room'** - сокет покидает в комнату, которую задали в параметре, сообщения отправленные в комнату больше не будут к нему приходить (пример: `Zcommon.socket.emit('leave room', roomname)`)
3. **'request'** - запрос данных с базы через сокет, сервер слушает событие **'request'** и запрашивает базу, и отправляет ответ к нему же, только к нему, через событие **'request '+uuid** (гарантируется через **uuid**), соответственно чтобы принять ответ сокет временно слушает событие **'request '+uuid**, после принятия ответа с сервера лиснер сразу удаляется (реализовано в функции (`_Z.socketioRequest`)
5. **'invalidate'** - отправляет данные на сервер в комнату одноименную с _**_z_matrecid**_ pushable датасоурса, сервер обрабатывает это событие, и данные отправленные сокетом транслирует всем сокетам в комнате через событие **'ds invalidate'** (кроме самого отправителя), реализовано для автообновления датасоурсов (точнее описано ниже, в разделе Инвалидация датасоурсов)
6. **'authentication'** - стандартное событие, авторизация через логин пароль
7. **'sendMessage'** - чат, отправляет обычные сообщение в комнату, это сообщение транслирует всем участникам комнаты через событие **'incomingMessage'* (реализовано в функции`_Z.sendMessageSocketio`)

### События которые клиентский сокет слушает (принимает с сервера)(`Zcommon.socket.on`)
1. **'connect'** - стандартное событие, срабатывает сразу после _**io.connect**_
authenticated
3. **'unauthorized'** - стандартное событие, срабатывает при попытке подклбчения сокета без авторизации
4. **'server_notify'** - лиснер для кастомных сообщений с сервера, сообщение отправляется через базу данных 
```sql 
select pg_notify('wsnotif', json_build_object('socket_id', 'WnHB6kiAqbdqXSorAAAB')::text); 
---socket_id обязателен(id сокета кому предназначено сообщение), доступен в таблице express_sessions
```
5. **'disconnect'** - стандартное событие, срабатывает при отключении сокета
6. **'ds invalidate'** - принимает данные для автообновления датасоурса
7. **'incomingMessage'** - чат, приходит сообщение от другого сокета, который состоит в той же комнате что и принимающий



# Инвалидация датасоурсов
##### В теле функции _Z.pageLoadData если датасоурс открываемой формы имеет проперти **pushable** делает `Zcommon.socket.emit('join room', roomname);` то есть подписывает датасоурс на автообновления, затем заполняет объекты **Zcommon.pushableDSmatrecids** и **Zcommon.subscribedDSmatrecids**

##### Датасоурс в котором были изменены данные отправляет данные на nodejs через функцию **_Z.invalidateDS**, node.js обрабатывает это событие и распространяет эти данные через, событие 'ds invalidate', во все сокеты которые подписаны на автообновления (сидят в одной комнате) 

##### Лиснер 'ds invalidate' реализован в теле функции **_Z.socketioConnect**, принимает **dataToPush**, **pushOptions**, если нужный датасоурс открыт то в нем продулывает изменения

- _**_Z.invalidateDS**_ - функция, вызывается в функциях **_Z.gridschemaparse** и **_Z.dsSchemaParse**
если датасоурс имеет проперти **pushable** и если **`responseType != read`** то измененные данные он кидает на сервак через событие `Zcommon.socket.emit('invalidate', data, pushOptions)` 

- _**_Z.formulateAllActivePushableDsMatrecids**_ - функция, пробегает по всем активным формам, ищет там датасоурсы которые имеют параметр **pushable**, и записывает их в массив **Zcommon.pushableDSmatrecids**. Вызывается в функции *_Z.closetab*, то есть при закрытии формы актуализирует список  pushable датасоурсов

- _**_Z.unsubscribeInactiveDS**_ - функция, пробегает по всем подписанным на инвалидацию датасоурсам (**Zcommon.subscribedDSmatrecids**), если их нет в списке **Zcommon.pushableDSmatrecids**, которая была актуализирована функцией выше, делает **leave room** событие. Вызывается в функции *_Z.closetab*, то есть при закрытии формы уже по актуализированному списку  pushable датасоурсов отписывает от комнаты автообновления неактивные pushable датасоурсы









