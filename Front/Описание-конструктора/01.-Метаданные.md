## Общее описание

После авторизации вызывается функция **_Z.init4**, где производится загрузка шаблонов GoJs (diagramTemplates.json) и вызов функции **_Z.socketioConnect** для подъема вебсокетов. В данной функции инициализируются листнеры вебсокета: 
- "authenticated"
- "unauthorized"
- "server_notify"
- "disconnect"
- "ds invalidate"
- "incomingMessage" (через функцию **_Z.handleIncomingMessage**)

Листнер "authenticated" вызывает функцию **_Z.metaVersionCheck** - стартовая функция работы с Метаданными.
В функции _Z.metaVersionCheck делается запрос текущей версии. Если в indexedDB нет данных о текущей версии или текущая версия устарела, то информация о текущей версии записывается в  indexedDB и запрашиваются новые метаданные (функция **_Z.refreshMetaData**). В противном случае вызывается функция **_Z.executeInitialQuery** - функция проверки наличия (в indexedDB) и при отсутствии выполнения запроса (функция **_Z.initialRequest**) начальных данных (типов сущностей, свойств сущностей, справочников, данных пользователя).
<br>При наличии начальных данных или после выполнения запроса начальных данных, производится разбор данных (функция _Z.initialRequestParse) и заполнение объекта Zcommon. А так же в этой функции проверяется наличие признака принятия **Соглашения** (**offer**), если Offer не принят, то вызывается функция открытия страницы **Offer** (функция **_Z.checkOffer**), если Offer принят, то вызывается функция **_Z.main**. Также эта функция вызывается из страницы Offer-а, при ее принятии.

В **_Z.main** производится чтение имеющихся Метаданных из indexedDB и их запись в объект _Z._cm_user_params.metaObj, при их отсутствии это будет пустой объект.
Дальнейшая проверка наличия Метаданных в indexedDB и при их отсутствии вызов функции запроса Метаданных производится функцией **_Z.getmetadata4**.
<br>В _Z.main с помощью функции _Z.getmetadata4 сперва загружаются в одном запросе данные MENU, PAGE, DATASOURCE, DATASOURCE_COLUMNS, dsTransport, JS_FRAGMENTS и следующим запросом функции вычисляемых полей.
После этих запросов вызывается функция **_Z.launch**, которая из объекта ZG['_z_openOnStart'] определяет какие страницы должны быть открыты при вхождении и открывает их с помощью функции **_Z.openPage**.

## Работа с indexedDB

Для работы с indexedDB создан плагин **$.zIndexedDB**.
<br>В объекте Zcommon.dbSchema определены структура и версия данных.
<br>Чтение Метаданных из базы indexedDB осуществляется следующей конструкцией:
<br>**_$.zIndexedDB(dbName, dbSchema).objectStore(dbObjStoreName).get(rootMatRecId).then()_**,
где:
- dbName - логин пользователя,
- dbSchema - объект Zcommon.dbSchema,
- dbObjStoreName - имя хранилища объектов,
- rootMatRecId - ключ в хранилище, значение которого хотим прочитать, если этот параметр опустить, то прочитаются все данные хранилища.

**_Z.storeToIndexedDB** - функция записи данных в хранилище, на вход подается объект с параметрами записи и данными.
<br>**_Z.deleteFromIndexedDB** - функция удаления данных из хранилища, на вход подается объект с параметрами удаляемых записей и удаляемые записи
<br>**_Z.clearIndexedDB** - удаление всех записей заданного хранилища.
<br>**_Z.refreshMetaData** - функция очищает все хранилища в текущей базе (dbName), закрывает все открытые страницы, производит чтение Метаданых и вызывает функцию _Z.executeInitialQuery (описан выше).

## Функции работы с Метаданными

**_Z.getmetadata4** - функция читает метаданные из indexedDB, при их отсутствии выполняет запрос. После получения метаданных вызывает функцию разбора метаданных **_Z.parseMeta**.

`Входные параметры: объект`
<br>*Ключи входного объекта:*
```javascript
dbName : <value>,
dbSchema : <value>,
dbObjStoreName : <value>,
keyField : <value>,
metaRoot: {
    rootMatRecId: <number>,    - Id корневого запрашиваемых данных
    pageRoot:  <boolean>,    - true означает, что запрашиваются данные страницы, при openPage()
    version: {},
},
forcibly: <boolean>,    - признак принудительного обновления Метаданных в indexedDB
metaType: <string>,    - тип запрашиваемых данных ('menu', 'page', 'calcField'...)
callback: <function>,    - функция выполняется после чтения и разбора Метаданных
callbackOptions: <value>,    - параметр, передаваемый в функцию callback
p: {},    - параметры, передаваемые в запрос Метаданных
cacheable:  <boolean>,    - если false, то при запросе Метаданных, данные не будут браться из кэш Node.js
```